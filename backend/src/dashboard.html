<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kantemba Analytics Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #ecfdf5 100%);
            min-height: 100vh;
            color: #1f2937;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            animation: fadeInDown 0.8s ease;
        }

        .header h1 {
            color: #065f46;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(6, 95, 70, 0.2);
        }

        .header p {
            color: #374151;
            font-size: 1.1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            animation: fadeInUp 0.8s ease 0.2s both;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(6, 95, 70, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #10b981, #059669);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(6, 95, 70, 0.15);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #718096;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            animation: fadeInUp 0.8s ease 0.4s both;
        }

        .chart-container {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-title::before {
            content: 'üìà';
            font-size: 1.5rem;
        }

        .data-sections {
            display: grid;
            gap: 20px;
            animation: fadeInUp 0.8s ease 0.6s both;
        }

        .data-section {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .events-title::before { content: '‚ö°'; }
        .errors-title::before { content: 'üö®'; }
        .reviews-title::before { content: '‚≠ê'; }

        .data-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .data-item {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.6);
            border-left: 4px solid #10b981;
            transition: all 0.3s ease;
        }

        .data-item:hover {
            background: rgba(255,255,255,0.9);
            transform: translateX(5px);
        }

        .error-item {
            border-left-color: #e53e3e;
            background: rgba(254, 226, 226, 0.6);
        }

        .review-item {
            border-left-color: #38a169;
            background: rgba(240, 253, 244, 0.6);
        }

        .item-header {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .item-meta {
            font-size: 0.85rem;
            color: #718096;
        }

        .rating {
            display: inline-flex;
            gap: 2px;
            margin-left: 8px;
        }

        .star {
            color: #ffd700;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #718096;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }

        .error-state {
            text-align: center;
            color: #e53e3e;
            padding: 40px;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 15px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .main-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
            }

            .stat-card {
                padding: 20px;
            }

            .stat-number {
                font-size: 2rem;
            }

            .chart-container,
            .data-section {
                padding: 20px;
            }

            .data-list {
                max-height: 300px;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .stat-number {
                font-size: 1.8rem;
            }

            .header h1 {
                font-size: 1.8rem;
            }
        }

        /* Animations */
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom scrollbar */
        .data-list::-webkit-scrollbar {
            width: 6px;
        }

        .data-list::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
            border-radius: 3px;
        }

        .data-list::-webkit-scrollbar-thumb {
            background: rgba(16, 185, 129, 0.6);
            border-radius: 3px;
        }

        .data-list::-webkit-scrollbar-thumb:hover {
            background: rgba(16, 185, 129, 0.8);
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <header class="header">
            <h1>Kantemba Analytics</h1>
            <p>Real-time insights and performance metrics</p>
        </header>

        <!-- Stats Overview -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="total-events">0</div>
                <div class="stat-label">Total Events</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-errors">0</div>
                <div class="stat-label">Total Errors</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-reviews">0</div>
                <div class="stat-label">User Reviews</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avg-rating">0.0</div>
                <div class="stat-label">Avg Rating</div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="main-grid">
            <div class="chart-container">
                <div class="chart-title">Feature Usage Overview</div>
                <canvas id="usageChart" width="400" height="200"></canvas>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">Event Types Distribution</div>
                <canvas id="eventsChart" width="200" height="200"></canvas>
            </div>
        </div>

        <!-- Data Sections -->
        <div class="data-sections">
            <div class="data-section">
                <div class="section-title events-title">Recent Events</div>
                <div class="data-list" id="events-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading events...
                    </div>
                </div>
            </div>

            <div class="data-section">
                <div class="section-title errors-title">Recent Errors</div>
                <div class="data-list" id="errors-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading errors...
                    </div>
                </div>
            </div>

            <div class="data-section">
                <div class="section-title reviews-title">User Reviews</div>
                <div class="data-list" id="reviews-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading reviews...
                    </div>
                </div>
            </div>
        </div>

        <div style="text-align: center;">
            <button class="refresh-btn" onclick="refreshAllData()">
                üîÑ Refresh Data
            </button>
        </div>
    </div>

    <script>
        // Global variables for charts
        let usageChart = null;
        let eventsChart = null;

        // Utility function to format timestamps
        function formatTimestamp(timestamp) {
            return new Date(timestamp).toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Generate star rating display
        function generateStars(rating) {
            const stars = [];
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 !== 0;
            
            for (let i = 0; i < fullStars; i++) {
                stars.push('<span class="star">‚òÖ</span>');
            }
            if (hasHalfStar) {
                stars.push('<span class="star">‚òÜ</span>');
            }
            for (let i = stars.length; i < 5; i++) {
                stars.push('<span style="color:#ddd">‚òÜ</span>');
            }
            
            return stars.join('');
        }

        // Fetch and render functions with error handling
        async function fetchAndRender(url, containerId, renderFn, fallbackData = []) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                renderFn(data);
            } catch (error) {
                console.error(`Error fetching ${url}:`, error);
                document.getElementById(containerId).innerHTML = `
                    <div class="error-state">
                        <div>‚ö†Ô∏è Unable to load data</div>
                        <div style="font-size: 0.9em; margin-top: 8px; color: #718096;">
                            ${error.message}
                        </div>
                    </div>
                `;
                // Use fallback data for demo purposes
                if (fallbackData.length > 0) {
                    setTimeout(() => renderFn(fallbackData), 1000);
                }
            }
        }

        // Render usage chart
        function renderUsageChart(data) {
            const ctx = document.getElementById('usageChart').getContext('2d');
            
            if (usageChart) {
                usageChart.destroy();
            }

            if (data.length === 0) {
                ctx.canvas.width = ctx.canvas.width; // Clear canvas
                ctx.font = '16px Inter';
                ctx.fillStyle = '#9CA3AF';
                ctx.textAlign = 'center';
                ctx.fillText('No usage data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            const labels = data.slice(0, 10).map(item => item._id || 'Unknown');
            const counts = data.slice(0, 10).map(item => item.count || 0);

            usageChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Usage Count',
                        data: counts,
                        backgroundColor: 'rgba(16, 185, 129, 0.8)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 2,
                        borderRadius: 6,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Render events distribution chart
        function renderEventsChart(data) {
            const ctx = document.getElementById('eventsChart').getContext('2d');
            
            if (eventsChart) {
                eventsChart.destroy();
            }

            if (data.length === 0) {
                ctx.canvas.width = ctx.canvas.width; // Clear canvas
                ctx.font = '16px Inter';
                ctx.fillStyle = '#9CA3AF';
                ctx.textAlign = 'center';
                ctx.fillText('No events data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            // Group events by type
            const eventTypes = {};
            data.forEach(event => {
                const type = event.type || 'Unknown';
                eventTypes[type] = (eventTypes[type] || 0) + 1;
            });

            const labels = Object.keys(eventTypes);
            const counts = Object.values(eventTypes);
            const colors = [
                'rgba(16, 185, 129, 0.8)',
                'rgba(5, 150, 105, 0.8)',
                'rgba(34, 197, 94, 0.8)',
                'rgba(6, 95, 70, 0.8)',
                'rgba(20, 83, 45, 0.8)'
            ];

            eventsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: counts,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        // Render events list
        function renderEventsList(data) {
            const container = document.getElementById('events-list');
            if (data.length === 0) {
                container.innerHTML = '<div class="data-item">No recent events</div>';
                return;
            }

            container.innerHTML = data.slice(0, 20).map(event => `
                <div class="data-item">
                    <div class="item-header">${event.type || 'Unknown Event'}</div>
                    <div class="item-meta">
                        ${event.event || ''} ‚Ä¢ ${formatTimestamp(event.timestamp)}
                    </div>
                    ${event.data ? `<div style="font-size: 0.8em; color: #4a5568; margin-top: 4px;">${JSON.stringify(event.data).substring(0, 100)}...</div>` : ''}
                </div>
            `).join('');

            // Update stats
            document.getElementById('total-events').textContent = data.length;
        }

        // Render errors list
        function renderErrorsList(data) {
            const container = document.getElementById('errors-list');
            if (data.length === 0) {
                container.innerHTML = '<div class="data-item">No recent errors üéâ</div>';
                return;
            }

            container.innerHTML = data.slice(0, 20).map(error => `
                <div class="data-item error-item">
                    <div class="item-header">${error.error || 'Unknown Error'}</div>
                    <div class="item-meta">${formatTimestamp(error.timestamp)}</div>
                    ${error.stack ? `<div style="font-size: 0.8em; color: #e53e3e; margin-top: 4px; font-family: monospace;">${error.stack.substring(0, 150)}...</div>` : ''}
                </div>
            `).join('');

            // Update stats
            document.getElementById('total-errors').textContent = data.length;
        }

        // Render reviews list
        function renderReviewsList(data) {
            const container = document.getElementById('reviews-list');
            if (data.length === 0) {
                container.innerHTML = '<div class="data-item">No reviews yet</div>';
                return;
            }

            container.innerHTML = data.slice(0, 20).map(review => `
                <div class="data-item review-item">
                    <div class="item-header">${review.review || 'No comment'}</div>
                    <div class="item-meta">
                        ${formatTimestamp(review.timestamp)}
                        <span class="rating">${generateStars(review.rating || 0)}</span>
                        <span style="margin-left: 8px;">(${review.rating || 0}/5)</span>
                    </div>
                </div>
            `).join('');

            // Update stats
            document.getElementById('total-reviews').textContent = data.length;
            const avgRating = data.reduce((sum, review) => sum + (review.rating || 0), 0) / Math.max(data.length, 1);
            document.getElementById('avg-rating').textContent = avgRating.toFixed(1);
        }

        // Refresh all data
        function refreshAllData() {
            // Show loading states
            document.getElementById('events-list').innerHTML = '<div class="loading"><div class="spinner"></div>Refreshing...</div>';
            document.getElementById('errors-list').innerHTML = '<div class="loading"><div class="spinner"></div>Refreshing...</div>';
            document.getElementById('reviews-list').innerHTML = '<div class="loading"><div class="spinner"></div>Refreshing...</div>';

            // Fetch all data
            loadDashboardData();
        }

        // Load all dashboard data
        function loadDashboardData() {
            // Fetch real data without fallbacks - show empty states if no data
            fetchAndRender('/api/analytics/usage', 'usageChart', renderUsageChart, []);
            fetchAndRender('/api/analytics/events', 'events-list', (data) => {
                renderEventsList(data);
                renderEventsChart(data);
            }, []);
            fetchAndRender('/api/analytics/errors', 'errors-list', renderErrorsList, []);
            fetchAndRender('/api/analytics/reviews', 'reviews-list', renderReviewsList, []);
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            
            // Auto-refresh every 5 minutes
            setInterval(loadDashboardData, 300000);
        });
    </script>
</body>
</html>